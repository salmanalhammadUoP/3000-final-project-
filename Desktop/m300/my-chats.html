<!DOCTYPE html>
<html>
<head>
  <title>My Chats</title>
  <style>
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; }
    nav { background: #2c3e50; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; color: white; }
    .back-btn { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    
    .container { max-width: 700px; margin: 30px auto; padding: 0 15px; }
    h2 { color: #2c3e50; margin-bottom: 15px; }
    
    .card { background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .row { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
    .row:hover { background: #fafafa; }
    
    .name { font-weight: bold; font-size: 16px; color: #2c3e50; }
    .preview { font-size: 14px; color: #777; margin-top: 5px; }
    .prefix-you { font-weight: bold; color: #555; }
    
    .unread-dot { width: 10px; height: 10px; background: #e74c3c; border-radius: 50%; }
  </style>
</head>
<body>

<nav>
  <div style="font-size: 18px; font-weight: bold;">My Conversations</div>
  <button class="back-btn" onclick="location.href='dashboard.html'">Back</button>
</nav>

<div class="container">
  <h2>Lawyers</h2>
  <div class="card" id="list">
    <p style="padding: 30px; text-align: center; color: #999;">Loading...</p>
  </div>
</div>

<script type="module">
  import { auth, db } from './js/firebase.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { collection, query, where, onSnapshot, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  onAuthStateChanged(auth, (user) => {
    if (user) loadInbox(user.uid);
    else window.location.href = 'login.html';
  });

  function loadInbox(myUid) {
    const q = query(collection(db, 'chats'), where('participants', 'array-contains', myUid));
    
    onSnapshot(q, async (snap) => {
      const div = document.getElementById('list');
      if (snap.empty) { div.innerHTML = '<p style="padding:30px; text-align:center;">No conversations found.</p>'; return; }

      let items = [];
      for (const d of snap.docs) {
        const data = d.data();
        const otherId = data.participants.find(id => id !== myUid);
        const uSnap = await getDoc(doc(db, 'users', otherId));
        const name = uSnap.exists() ? uSnap.data().name : "Lawyer";
        
        items.push({ id: otherId, name: name, ...data });
      }

      items.sort((a, b) => (b.lastUpdate?.seconds || 0) - (a.lastUpdate?.seconds || 0));

      div.innerHTML = items.map(item => {
        // Check if *I* sent the last message
        const isMe = item.lastSenderId === myUid;
        const prefix = isMe ? '<span class="prefix-you">You:</span> ' : '';
        const showDot = !isMe && item.lastSenderId; // Only show dot if I DID NOT send it

        return `
          <div class="row" onclick="openChat('${item.id}', '${item.name}')">
            <div>
              <div class="name">${item.name}</div>
              <div class="preview">${prefix}${item.lastMessage || 'Start conversation'}</div>
            </div>
            ${showDot ? '<div class="unread-dot"></div>' : ''}
          </div>
        `;
      }).join('');
    });
  }

  window.openChat = (id, name) => {
    localStorage.setItem('selectedLawyer', JSON.stringify({id, name}));
    window.location.href = 'chat.html';
  };
</script>
</body>
</html>